<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة التحكم - متجري</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: #f1f1f1;
      margin-left: 5px;
      border-radius: 5px 5px 0 0;
    }
    .tab.active {
      background: #4CAF50;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #4CAF50;
      color: white;
    }
    tr:hover {
      background-color: #f5f5f5;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #45a049;
    }
    .btn-danger {
      background-color: #f44336;
    }
    .btn-danger:hover {
      background-color: #d32f2f;
    }
    .btn-edit {
      background-color: #2196F3;
    }
    .btn-edit:hover {
      background-color: #0b7dda;
    }
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    .preview-image {
      max-width: 100px;
      max-height: 100px;
      display: block;
      margin-top: 10px;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    // نفس إعدادات Firebase المستخدمة في المتجر
    const firebaseConfig = {
      apiKey: "AIzaSyD-2XyDdRd96bMke...",
      authDomain: "waeilstore-88caa.firebaseapp.com",
      projectId: "waeilstore-88caa",
      storageBucket: "waeilstore-88caa.appspot.com",
      messagingSenderId: "688257524364",
      appId: "1:688257524364:web:f52aad..."
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>
<body>
  <div class="container">
    <h1>لوحة تحكم المتجر</h1>
    
    <div class="tabs">
      <div class="tab active" onclick="openTab('products-tab')">المنتجات</div>
      <div class="tab" onclick="openTab('add-product-tab')">إضافة منتج</div>
    </div>
    
    <div id="products-tab" class="tab-content active">
      <h2>قائمة المنتجات</h2>
      <table id="products-table">
        <thead>
          <tr>
            <th>الصورة</th>
            <th>الاسم</th>
            <th>الوصف</th>
            <th>السعر</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody id="products-list">
          <!-- سيتم ملؤها بالمنتجات من Firebase -->
        </tbody>
      </table>
    </div>
    
    <div id="add-product-tab" class="tab-content">
      <h2>إضافة منتج جديد</h2>
      <form id="product-form">
        <input type="hidden" id="product-id">
        
        <div class="form-group">
          <label for="name">اسم المنتج:</label>
          <input type="text" id="name" required>
        </div>
        
        <div class="form-group">
          <label for="description">وصف المنتج:</label>
          <textarea id="description" rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label for="price">السعر (د.ت):</label>
          <input type="number" id="price" step="0.01" required>
        </div>
        
        <div class="form-group">
          <label for="image">رابط صورة المنتج:</label>
          <input type="url" id="image">
          <img id="image-preview" class="preview-image" style="display: none;">
        </div>
        
        <button type="submit" id="save-btn">حفظ المنتج</button>
        <button type="button" id="cancel-btn" style="display: none;">إلغاء</button>
      </form>
    </div>
  </div>

  <script>
    // متغيرات عامة
    let editingProductId = null;
    
    // فتح تبويب
    function openTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab[onclick="openTab('${tabId}')"]`).classList.add('active');
    }
    
    // عرض معاينة الصورة
    document.getElementById('image').addEventListener('input', function() {
      const preview = document.getElementById('image-preview');
      if (this.value) {
        preview.src = this.value;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
    });
    
    // تحميل المنتجات
    function loadProducts() {
      const productsList = document.getElementById('products-list');
      productsList.innerHTML = '<tr><td colspan="5">جاري التحميل...</td></tr>';
      
      db.collection("products").get().then(snapshot => {
        productsList.innerHTML = '';
        
        if (snapshot.empty) {
          productsList.innerHTML = '<tr><td colspan="5">لا توجد منتجات</td></tr>';
          return;
        }
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><img src="${data.image || 'https://via.placeholder.com/100'}" alt="${data.name}" style="max-width: 80px;"></td>
            <td>${data.name}</td>
            <td>${data.description || '-'}</td>
            <td>${data.price} د.ت</td>
            <td class="action-buttons">
              <button class="btn-edit" onclick="editProduct('${doc.id}')">تعديل</button>
              <button class="btn-danger" onclick="deleteProduct('${doc.id}')">حذف</button>
            </td>
          `;
          productsList.appendChild(row);
        });
      }).catch(err => {
        console.error("Error loading products:", err);
        productsList.innerHTML = '<tr><td colspan="5">حدث خطأ أثناء تحميل المنتجات</td></tr>';
      });
    }
    
    // حذف منتج
    function deleteProduct(productId) {
      if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
        db.collection("products").doc(productId).delete()
          .then(() => {
            alert('تم حذف المنتج بنجاح');
            loadProducts();
          })
          .catch(err => {
            console.error("Error deleting product:", err);
            alert('حدث خطأ أثناء حذف المنتج');
          });
      }
    }
    
    // تعديل منتج
    function editProduct(productId) {
      editingProductId = productId;
      db.collection("products").doc(productId).get()
        .then(doc => {
          if (doc.exists) {
            const data = doc.data();
            document.getElementById('product-id').value = productId;
            document.getElementById('name').value = data.name;
            document.getElementById('description').value = data.description || '';
            document.getElementById('price').value = data.price;
            document.getElementById('image').value = data.image || '';
            
            const preview = document.getElementById('image-preview');
            if (data.image) {
              preview.src = data.image;
              preview.style.display = 'block';
            } else {
              preview.style.display = 'none';
            }
            
            document.getElementById('save-btn').textContent = 'تحديث المنتج';
            document.getElementById('cancel-btn').style.display = 'inline-block';
            openTab('add-product-tab');
          }
        })
        .catch(err => {
          console.error("Error getting product:", err);
          alert('حدث خطأ أثناء تحميل بيانات المنتج');
        });
    }
    
    // إلغاء التعديل
    document.getElementById('cancel-btn').addEventListener('click', function() {
      resetForm();
      openTab('products-tab');
    });
    
    // إعادة تعيين النموذج
    function resetForm() {
      document.getElementById('product-form').reset();
      document.getElementById('product-id').value = '';
      document.getElementById('image-preview').style.display = 'none';
      document.getElementById('save-btn').textContent = 'حفظ المنتج';
      document.getElementById('cancel-btn').style.display = 'none';
      editingProductId = null;
    }
    
    // حفظ المنتج
    document.getElementById('product-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const productId = document.getElementById('product-id').value;
      const name = document.getElementById('name').value;
      const description = document.getElementById('description').value;
      const price = parseFloat(document.getElementById('price').value);
      const image = document.getElementById('image').value;
      
      const productData = {
        name,
        description,
        price,
        image,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      if (productId) {
        // تحديث منتج موجود
        db.collection("products").doc(productId).update(productData)
          .then(() => {
            alert('تم تحديث المنتج بنجاح');
            resetForm();
            loadProducts();
            openTab('products-tab');
          })
          .catch(err => {
            console.error("Error updating product:", err);
            alert('حدث خطأ أثناء تحديث المنتج');
          });
      } else {
        // إضافة منتج جديد
        productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        
        db.collection("products").add(productData)
          .then(() => {
            alert('تم إضافة المنتج بنجاح');
            resetForm();
            loadProducts();
            openTab('products-tab');
          })
          .catch(err => {
            console.error("Error adding product:", err);
            alert('حدث خطأ أثناء إضافة المنتج');
          });
      }
    });
    
    // تحميل المنتجات عند فتح الصفحة
    window.addEventListener('load', loadProducts);
  </script>
</body>
</html>